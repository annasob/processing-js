<html> 
  <head>   
    <script language="javascript" src="../../../processing.js"></script> 
    <script language="javascript" src="init.js"></script> 
    <script language="javascript" src="dsp.js"></script> 
  </head> 
  <body> 
    <style> 
      body { background: black; margin:0; padding:0;}
    </style> 
    
    <script> 
    var spectrum = [];
    var signal = [];
    var peak = [];
    var bufferSize = 2048;
    
    var fft = new FFT(bufferSize, 44100);
 
    function audioWritten(event) {
      var mozSignal = event.mozFrameBuffer;
     
      if ( mozSignal.length == 4096 ) { 
      
        // Problem: The audioWritten buffer should be 4096 samples, 2048 per channel. 
        // FFT running in js can't process 2048 samples quick enough and it gets quite laggy 
        // so we only look at the first 1024 samples and scrap the rest.
        for ( var i = 0; i < mozSignal.length/2; i++ ) {
          // Assuming interlaced stereo channels, need to split and merge into a stero-mix mono signal
          signal[i] = (mozSignal.item(2*i) + mozSignal.item(2*i+1)) / 2; 
        }
        
        //var complexValues = calculateFFT2(signal);
        
        fft.forward(signal);
        
        // calculate peak values
        
        for ( var i = 0; i < fft.spectrum.length; i++ ) {
          fft.spectrum[i] *= -1 * Math.log((signal.length/2 - i) * (0.5/signal.length/2)) * 2048; // equalize, attenuates low freqs and boosts highs
          
          if ( typeof(peak[i]) == 'undefined' || peak[i] < fft.spectrum[i] ) {
            peak[i] = fft.spectrum[i];
          } else {
            peak[i] *= 0.99; // peak slowly falls until a new peak is found
          }
        }
      }
    }
    </script> 
    
    <script target="#fft" type="application/processing"> 
    void setup() {
      size(1024, 500);
      colorMode(HSB, 360, 100, 100);
      strokeWeight(1);
      strokeWeight(1.0);
    }
    
    void draw() {
      background(255);
      
      for ( int i = 0; i < fft.spectrum.length/2; i += 2 ) {
        if (2*i > width) { break; }
        
        var magnitude = fft.spectrum[i];
        
        // draw magnitudes
        stroke((i) % 360, 60, constrain(magnitude * 6, 20, 100));
        line(2*i, height, 2*i, height - magnitude * 16);
        
        // draw peak indicators
        stroke((i) % 360, 60, constrain(magnitude * 100, 50, 100));
        line(2*i, height - peak[i] * 16 - 1, 2*i, height - peak[i] * 16);
      }
    } 
    </script> 
    
    <audio src="corban2.ogg" controls="true" onaudiowritten="audioWritten(event);" style="width:100%;"></audio><br /> 
    
    <div><canvas id="fft" style="width:100%; height:500px;"></canvas></div> 
  </body> 
</html> 